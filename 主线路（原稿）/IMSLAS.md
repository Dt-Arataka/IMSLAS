# IMSLAS

## 一、硬件资源介绍

### 1.核心开发板：ESP32S3

单片机型号：**ESP32-S3-WROOM-1-N16R8**
>**具体参数：**

>**N16:**  16 MB 的 Quad SPI Flash (闪存)
**R8:**  8 MB 的 Octal SPI PSRAM (伪静态随机存取存储器)

>**核心处理器 (CPU)**
核心： Xtensa® 双核 32-bit LX7 微处理器
时钟速度： 最高可达 240 MHz
片上内存 (SRAM)： 512 KB   
（这是“极速内存”,它就在 CPU 旁边，存取速度最快，但容量较小。
关键数据暂存： 用于存储程序的堆栈 (Stack)、中断服务程序 (ISR) 和最核心的变量。）
只读内存 (ROM)： 384 KB
（这是出厂时烧录好的“固化代码”，不可修改。它包含了 ESP32-S3 的启动程序 (Bootloader) 和一些基础的底层函数库（如蓝牙协议栈的底层）。它在幕后默默工作，确保芯片能启动。）
RTC 内存： 16 KB SRAM in RTC
（这是“低功耗内存”。当您让 ESP32-S3 进入深度睡眠 (Deep Sleep) 模式以省电时，主 CPU 会关闭，SRAM 数据会丢失，但 RTC 内存依然由电池（如有）供电保持数据。）

>**外部存储 (N16R8 的关键)**
Flash (闪存)： 16 MB (Quad SPI)
（用于存储您的程序、LVGL 库、图片、字体和数据库。这是您的“硬盘”。断电后数据不丢失。标准的 ESP32 通常只有 4MB，而您有 16MB，非常巨大。）
PSRAM (内存)： 8 MB (Octal SPI)
（用于 UI 绘图缓冲区、图表数据、ADC 采样阵列和深度学习模型。这是“扩展内存”。它的速度比 SRAM 慢一点，但比 Flash 快得多，而且容量是 SRAM 的 16 倍！）

>**无线通信**
Wi-Fi 协议： IEEE 802.11 b/g/n
Wi-Fi 频率： 2.4 GHz (2412 ~ 2484 MHz)
Wi-Fi 速率： 802.11n 模式下最高可达 150 Mbps
蓝牙协议： Bluetooth 5 (LE), 支持 Bluetooth mesh
蓝牙速率： 125 Kbps, 500 Kbps, 1 Mbps, 2 Mbps

### 2.屏幕介绍

屏幕介绍：https://www.lcdwiki.com/zh/3.5inch_IPS_SPI_Module_ST7796#%E4%BA%A7%E5%93%81%E5%9B%BE%E7%89%87
### 3.外置ADC介绍

#### 1.芯片型号：ADS8681 
> 分辨率：16 bit 
> 采样速率：1 MSPS (最大值) 
> 基准电压：内部 4.096V 
> 通道数：单通道 
> 输入阻抗：$\ge 1 M\Omega$  
> 输入接口：接线端子 或 SMA 
> 输入带宽：15 KHz  
> 输入量程 (软件可编程)：
    >>双极性量程：$\pm 2.56V$、$\pm 5.12V$、$\pm 6.144V$、$\pm 10.24V$、$\pm 12.288V$ 
    >>单极性量程：$0V \sim 5.12V$、$0V \sim 6.144V$、$0V \sim 10.24V$、$0V \sim 12.288V$
>    
> 通信与数字接口模块通信协议：SPI 
> 通信速率：66.67 MHz
#### 2.引脚功能
> 1.    CS (Chip Select / $\overline{CS}$):功能: 片选信号（低电平有效）。
>       操作: ESP32 拉低此脚以启动一帧数据传输（或启动一次转换，取决于配置）。传输结束后拉高。
> 2.    SCLK (Serial Clock):功能: 时钟信号。
>       操作: 由 ESP32 产生时钟脉冲，决定数据传输的快慢。ADS8681 支持最高 66.67 MHz 的时钟 ，完全匹配 ESP32 的高速 SPI 能力。
> 3.    SDI (Serial Data In / MOSI):功能: 数据输入（Master Out Slave In）。
>       操作: ESP32 通过此引脚向 ADC 发送命令。这在您的项目中非常重要，因为您需要通过 SDI 发送指令将输入量程配置为 0 ~ 5.12V 或 0 ~ 10.24V，否则默认量程可能不适合您的信号。
> 4.    SDO0 (Serial Data Out 0 / MISO):功能: 主数据输出（Master In Slave Out）。
>       操作: ADC 转换好的 16位数字信号通过此引脚传回 ESP32。这是您读取离子谱图数据的主要通道。 
> 5.    RST (Reset):功能: 硬件复位（低电平有效）。
      操作: 在系统上电初始化时，ESP32 应短暂拉低此引脚，确保 ADC 处于已知的初始状态。
> 6.    RVS (Read Valid Signal):功能: 数据有效/忙信号。这是 ADS8681 的一大特色。
>      操作:当 RVS 为 高电平 时，表示 ADC 正在输出有效数据或处于空闲状态;当 RVS 变低电平时，通常表示转换正在进行中。
> 7.    SDO1:功能: 第二数据输出（用于 Dual SPI 模式）。
>       操作: ADS8681 支持双线并行输出数据以加倍传输速度。
## 二、项目概况: 

**基于离子迁移谱的自主化学源定位系统（IMSLAS-Localization and Autonomous Seeking)**
本项目旨在开发一款**基于离子迁移谱的自主化学源定位系统(IMSLAS)**。与仅能对样本进行定性/定量分析的传统IMS设备不同，本系统在保留核心物质识别能力的基础上，创新性地实现了 **“识别 + 定位”一体化功能**。设备对目标物质（如特定危险品、污染物）进行“嗅探”校准，提取并存储该物质的离子迁移率谱图特征；将设备搭载于无人机或四足机器人等移动平台，在作业环境中实时监测目标物质的浓度梯度。系统利用**类生物趋化性算法（Chemotaxis Algorithm）**，根据浓度变化实时解算运动矢量，驱动平台向高浓度区域逼近，最终锁定目标物质的精确空间位置，实现从“发现”到“定位”的全自动闭环。本系统基于高性能双核MCU **ESP32-S3-WROOM-1-N16R8** 构建，采用Platformio平台的Arduino框架进行嵌入式开发。

按照系统架构，嵌入式软件开发被拆解为以下四个关键技术模块，每个模块都进行了深度的功能定义与逻辑细化：

1. **离子门控时序发生器**

   产生高精度的驱动信号，控制离子门的开闭时序。

2. **交互式人机界面设计**

   **核心任务：** 构建基于3.5英寸TFT屏幕的可视化操作终端。

   **硬件规格：** 分辨率320×480 (Pixel)，采用高效的4线SPI通讯接口；显示驱动IC为ST7796U，电容触摸驱动IC为FT6336U。

   **功能实现：** 设计基于事件驱动的UI架构，优化SPI传输效率（如使用DMA传输）以保证高刷新率。

   **六大功能模块划分：**

   1. **物质识别与分析（Analysis）：** 显示当前检测物质名称及置信度；
   2. **实时导航显示（Navigation）：** 显示平台运动轨迹、方向指引及相对位置；
   3. **浓度可视化（Concentration）：** 以波形或色阶形式直观呈现浓度变化趋势；
   4. **物质学习校准（Calibration）：** 录入新物质的谱图特征进行训练；
   5. **系统状态监测（Status）：** 监控高压源、温度、气流及电池电压；
   6. **系统设置（Settings）：** 调节离子门脉宽、采集增益等底层参数。

3. **高速数据采集与信号处理**

    核心任务是捕获微弱的离子流信号并转化为数字谱图。驱动外置高精度、高采样率ADC对经过放大的模拟信号进行离散化采集并且在屏幕上实时绘制“电压-时间”波形（即离子迁移谱图）。计算不同离子峰的**飞行时间（Time of Flight, ToF）**，结合漂移管长度与电场强度，反演计算出物质特有的**迁移率（$K_0$）**，以此作为物质识别的“指纹”依据。利用外置的高速高精度ADC采集电压信号（由离子门进来的被电离的物质产生的电流信号，再经过跨阻放大器得到电压信号），并且将波形呈现在屏幕上，记录不同物质离子的迁移率，根据此可以实现离子迁移谱分析仪的功能。

4. **定位算法设计**

   在实现能分辨出物质功能的前提下，设计循迹算法，使其能精准定位该物质源，并且其浓度和循迹过程可以显示在屏幕上。

## 三、UI交互式界面设计

### 1.使用thonny软件进行python开发
一开始，我对嵌入式如何开发完全不懂，听取老师意见首先使用python语言来对ESP32进行开发，我的想法是python更加容易上手，而且开发起来更加方便，python语言我也稍微熟悉一点，随即开始了项目。
首先使用thonny软件对单片机进行刷micropython固件，在thonny平台上进行开发，并且同步也在b站上学习相对应的课程，但是随着对此开发方式更加深入了解后，发现其并不能满足我对此项目的开发需求，理由如下：
> - 当我开始调研市面上的屏幕时，发现各商家提供的屏幕驱动和开发例程均为STM32居多，也有不少商家有ESP32开发板的驱动但清一色全为arduino平台。如果我坚持要使用micropython来开发的话或与只能在GitHub上才能找到相关屏幕的驱动程序，而且是否能找到或者找到后对于我这样一个嵌入式小白来说能否成功移植也是很大的挑战。
> - 当我意识到可能需要换种开发方式后我对此进行了更深入的探究，比如不止于屏幕的开发，在之后的开发中是否也可能出现类似的问题。于是我有了必须换种方式开发此项目的理由：
    >> - 网上arduino开发的资料明显多于micropython开发的资料
    >> - 此后要实现高速高精度ADC采集这一功能，micropython属于编译型语言不如C或C++更加底层

所以我开始摒弃之前学习的micropython开发框架，转用arduino框架开发

### 2.移植屏幕相关驱动程序
拿到购买的屏幕后第一个要实现的功能就是想办法先“点亮屏幕”，也就是成功将商家给的显示屏和触摸屏的驱动代码移植到自己的单片机上。
#### 1.移植显示屏驱动（ST7796）
万事开头难，对于“驱动”以及“移植”这个概念我是完全不懂，所以花费了一些时间首先去了解嵌入式中的这些概念和实操方法，在了解个大概之后我便开始实操。
中间移植过程省略，在所有流程全部走完之后，发现屏幕依旧没有反应，于是我开始不断尝试不同的方法，最后经历痛苦的折磨后终于解决了问题，具体问题和解决方案如下：
>在配置好文件后，一切准备就绪，上电烧录上述测试代码，出现问题：烧录好的一瞬间屏幕点亮，亮起时间不足一秒又立马熄灭，按reset键又短暂重新亮起 （屏幕亮起的一瞬间能显示测试代码内容，可以说明接线以及测试代码都没有问题）。
可能出现的问题
**供电的问题：** 
屏幕供电3.3V不够用（ ESP32-S3 和屏幕背光在启动瞬间的总电流消耗，超过了您当前 USB 供电所能提供的瞬时最大电流，导致 ESP32-S3 芯片电压跌落并崩溃重启。），需要接5V供电（商家标注该屏幕3.3V/5V供电都可行，找不到其它出错的可能，只能尝试5V供电是否可行），然而开发板上没有5V供电接口，只能去实验室进行试验，在接上5V电源后依然短暂亮起又熄灭，问题没解决。
**配置文件的问题:**
仔细重新一步一步看了User_Setup.h文件的配置情况，发现问题所在：背光是“低电平”点亮的，而我将其设置成了高电平。将 #define TFT_BACKLIGHT_ON HIGH 更改为#define TFT_BACKLIGHT_ON LOW,成功解决。

#### 2.移植触摸屏驱动和lvgl库
在有了移植显示屏驱动的经验后，触摸屏的驱动移植方法也只是略有不同，不过过程也略显艰辛，遇到了问题，其解决方法如下：
>**问题：** 一开始只接了3根线，由于触摸复位引脚没什么用不用接，但是不管怎么测试触摸的功能都没有实现，代码也没出现报错，甚至怀疑是硬件层出现问题，不是代码的问题
>**解决方法：**
ts.begin() 函数会调用 ts.reset()。ts.reset() 函数会主动控制 pinRst 引脚。在测试代码中，我们将 CTP_RST_PIN 设置为 -1 (未连接)。digitalWrite(-1, ...) 可能会导致未定义的行为。最终将认为“没用”的CTP_RST引脚接上后解决。

lvgl库是用来设计UI界面的库，所以也需要修改配置文件来匹配我们的屏幕。


### 3.UI交互式界面设计
#### 1.开机界面设计
我们选用的lvgl库来进行UI交互界面设计，在开始设计之前，先在网上学习如何使用lvgl库，发现网上清一色的教程均基于STM32进行教学，但我的想法是板子不同，但开发逻辑一致，经过调研发现网上的教学均较复杂，学习和设计的时间成本均较大，并且这部分内容不是我们该项目的重点内容，故开始另辟蹊径，找图形化设计的方法。之后使用Squareline图形化设计软件进行UI开发，提高了效率。首先设计了简单的图形界面仅可以显示波形即可。
#### 2.模拟信号波形产生
首先重新对离子迁移谱分析仪作更深入的了解，弄清楚其分析物质的根本原理以及采集的信号波形是如何的，再根据真实的仪器显示的波形进行模仿，生成模拟的波形，之后adc采集功能实现后，只需要将产生模拟波形这一部分的函数用ADC采集波形这一功能的库进行代替即可。
难点：在进行这一功能时，需要用指针调用UI设计时波形曲线的句柄，以及对相关按键进行事件设计，再调用该事件函数，需要熟悉其相关函数用法，以及逻辑清晰。


### 4.项目相关技术学习
#### 1.从Arduino平台移植到VScode的Platformio平台
由于后续还有很多功能需要实现，arduino平台在项目管理这一方面不尽人意，比如要打开新的项目需要另开窗口，而且启动速度慢，占用后台内存较大等等。经过调研发现VScode软件也能进行嵌入式开发，并且更加专业，管理项目也更加好用，随后经过自己摸索和网上办法的学习完成了项目的转移。
#### 2.git分布式管理软件的学习
在后续的项目中需要实现ADC采集的功能，相关算法功能的实现，并且将这些功能全部融入到UI设计的项目当中，所以必须要做版本管理，git可以很好的实现此项功能。


### 5.ADC采集信号的实现
#### 1.ADC采集模块的调研
经过调研和合理的计算，采购的模块为ADS8681，1M采样率和16位分辨率，理由如下：
- 1M采样率：1M意味着每秒采集信号1M次，也就是每1us采集一个点，而离子迁移谱分析仪的离子信号一个离子峰宽度为50us左右，一个离子峰用50个点采集，可以达到要求。
- 16位分辨率：采集进的来自跨阻放大器的电压量程约为5V，16位的分辨率可以将5V电压分成2的16次方，足够精细完全可以分辨出离子峰，满足要求。
#### 2.ADC采集功能的实现
市面上的adc模块商家提供的驱动程序大多只有STM32的相关例程，其代码的调用GPIO口的函数以及代码都和ESP32S3不同，所以只好自己写相关的驱动程序，遇到问题解决问题，在不断的修改完善后，终于实现了采集的功能，能成功读取到电压信号。


### 6.ADC采集功能与UI结合及性能提升
#### 1.功能结合
在采集信号的功能实现之后，将该功能封装成了库，后续将库文件载入UI文件中，在代码中调用该功能即可。
难点：
- 同时使用cpu采集信号和刷新屏幕时可能会引起冲突，所以涉及到RTOS的知识，如何刷新屏幕和采集信号这两个功能有规律的交替进行，必须使用互斥锁，在一个功能时拿到锁完成时释放锁，另外一个功能再拿锁。
- 屏幕和ADC采集都是SPI总线，所以如何能使两者在传输数据时不发生冲突，而ESP32S3单片机正好有HSPI和FSPI两个可以供外设使用的SPI总线，在代码中将这两个功能分别使用一个总线。
- ESP32S3单片机一共有两个核心（core0和core1），让UI功能和采集信号的功能分别占用一个核心，减轻cpu的压力。
#### 2.性能提升
在成功将两者功能结合起来之后，发现采样率并未达到预期的1M。开始锁定问题发现是ADC采集功能所用的方法

### 7.实现采集功能和离子门脉冲信号的同步

#### 1.使用CPU产生低电平和高电平，在电平产生的时候来实现同步
刚开始的想法是使用CPU控制引脚产生高低电平,在产生高电平时，立即让ADC实现采集功能，此时CPU只需要等待ADC采集结束后来进行数据处理，当一个周期结束后，采集也立马结束。但是当实际运行该代码时发现系统卡住，点击开始扫描也毫无反应。随即分析逻辑发现可能是CPU压力太大，而且这个方案有很多问题，思考过后，改用另一种方案。

#### 2.使用LEDC硬件脉冲+GPIO中断触发实现同步

为了不让CPU压力过大，使用专门的PWM波外设产生干净稳定的脉冲信号，再使用中断检测上升沿，立马唤醒采集任务，这样系统成功运行。

#### 3.系统逻辑描述

- 在开始上电一瞬间，一系列基础的设施首先搭建好，比如绘制的UI界面、LEDC产生的脉冲信号、分配大内存用来存储ADC采集的数据等等。当我点击开始扫描按钮时，此时中断任务开启，当检测到LEDC信号从低电平到高电平时，中断立马停止CPU一切工作立即执行ADC采集任务，从而实现同步功能。也就是说在离子门开启当离子被放进迁移管时，ADC就开始采集，在刚开始时，ADC没有采集到电压，是因为离子此时正在迁移管中迁移，当采集到离子峰的电压时，意味着这一个周期即将结束，开始下一个周期的采集。所以说，由于我的UI横轴时间设置为了24ms，控制离子门的脉冲信号的一个周期必须比24ms更长，这样才不至于发生系统崩溃。当积累了16个周期的采集数据后，将这16个周期的ADC采集数据进行累加平均（用来消除噪声），再用区间找最大值（以防离子峰的宽度太窄从而没画到屏幕上）生成200个点绘制到屏幕上。
  1.	在上电瞬间，系统完成基础设施搭建：分配大块内存用于存储海量数据（ADC采集），UI 界面绘制完成。同时，LEDC 硬件外设立即开始在引脚上产生脉冲信号。虽然脉冲在发，但由于扫描开关未打开，系统对这些信号“视而不见”，ADC 处于待机状态。
  1.	当点击“开始扫描”按钮并且当 LEDC 信号产生**上升沿（从 0 变 1）**的那一微秒：离子门打开，离子群瞬间被放入漂移管，开始飞行。GPIO 硬件中断立即触发，强行打断 CPU 当前的所有低优先级工作（如 UI 刷新），以**零延迟**唤醒 ADC 采集任务。这确保了**软件采集的起点**与**物理离子进入的起点**严格对齐，实现同步。
  1.	ADC 任务被唤醒后，立即启动高速采集，直到采集到分配的内存（刚好填满屏幕大小的数据，也就是1M SPS 采集24 ms）被填满为止。在前几毫秒，离子还在管子前段，ADC 采集到的是基线噪声和 RIP 峰。在中间时段，目标离子飞抵检测器，ADC 采集到离子峰电压。在结束时段，ADC 继续采集直到填满 24ms 的数据长度，确保捕捉到所有慢速离子。
  1.	在 T=24ms 时，ADC 采集结束。此时距离下一个脉冲到来（T=30.3ms）还有约6ms 的空闲时间。在这 6ms 内，CPU 并没有闲着，它快速进行数据累加处理。
  1.	系统重复上述过程。每采集完 1 次，就将这 24ms 的数据累加到缓存中。 当**攒够 16 个周期**（约 0.5 秒）后，将累加的数据除以 16，极大地消除了随机白噪声，让波形变光滑。利用 **“区间最大值”** 算法，将 24000 个高密度点压缩为 200 个屏幕像素点，确保即使极窄的离子峰也能在屏幕上显现，不会因为缩小而被“漏掉”。将处理好的波形刷新到 UI 界面，完成一次视觉更新。随后，清空缓存，准备迎接下一轮的 16 次循环。
  
- 在 T=24ms 时，ADC 采集结束。此时距离下一个脉冲到来（T=30.3ms）还有约6ms 的空闲时间。在这 6ms 内，CPU 并没有闲着，它快速进行数据累加处理。我的ADC采集任务和UI绘图在两个不同的核心，为什么还要留时间来进行绘图，不能同时进行吗

  这 6ms 的空闲时间，**主要是留给 Core 1（采集核）自己用的**，而不是给 Core 0（UI 核）用的。虽然你有两个核，但 Core 1 既负责“搬砖（采集）”也负责“砌墙（累加运算）”，它分身乏术，无法在同一时间既采数据又算数据。

- 我的离子门周期大小必须超过24 ms吗，我要是设置1 ms的周期会发生什么，那CPU此时不能边采集边进行数据处理吗

  若设置1ms的波形周期，此时会不断有离子峰涌入，谱图上不再有清晰的峰，而是一锅粥，造成“重叠干扰”。

- 我将产生离子门的引脚和ADC采集引脚接在了一块，产生如图所示的波形，这是什么原因(在 T=0 处有一个巨大的尖峰，后面全是平的。)
![alt text](1.jpg)
离子门脉冲宽度只有 250µs (0.25ms) 或 500µs (0.5ms)。在屏幕上，这个脉冲只占非常窄的一瞬间。那个尖峰就是发出的离子门脉冲,因为它太短了，所以在长达 24ms 的图表上看起来就像一根针。

- 当我将该参数IMS_AVG_COUNT ，也就是累加次数改为4或者更低的数字后，我的屏幕上的波形就会一直向左移动，如果改为原来的16，就是固定在屏幕上，显示正常，这是什么原因

  采集完后，要进行**繁重的计算**（除法平均 + 200次峰值搜索 + 抢互斥锁 + 内存拷贝）。假设这套动作耗时 **4ms**。当设为 4 时，**繁重的计算**和**UI刷新**变得非常频繁，让 CPU 始终处于“高压状态”